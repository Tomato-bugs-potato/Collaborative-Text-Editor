name: Distributed System Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run tests daily at 2 AM
    - cron: '0 2 * * *'

jobs:
  load-test:
    name: Load Distribution Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          cd test
          npm install
      
      - name: Run Load Test
        run: |
          cd test
          npm run test:load
        env:
          API_GATEWAY: ${{ secrets.API_GATEWAY_URL }}
          NUM_USERS: 30
      
      - name: Upload Load Test Results
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results
          path: test/results/load-test-*.json

  failover-test:
    name: Database Failover Test
    runs-on: ubuntu-latest
    needs: load-test
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
      
      - name: Configure Kubernetes
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" > $HOME/.kube/config
      
      - name: Install dependencies
        run: |
          cd test
          npm install
      
      - name: Run Failover Test
        run: |
          cd test
          npm run test:failover
      
      - name: Upload Failover Test Results
        uses: actions/upload-artifact@v4
        with:
          name: failover-test-results
          path: test/results/failover-test-*.json

  e2e-test:
    name: End-to-End Integration Test
    runs-on: ubuntu-latest
    needs: load-test
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          cd test
          npm install
      
      - name: Run E2E Test
        run: |
          cd test
          npm run test:e2e
        env:
          API_GATEWAY: ${{ secrets.API_GATEWAY_URL }}
      
      - name: Upload E2E Test Results
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: test/results/e2e-test-*.json

  generate-report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: [load-test, failover-test, e2e-test]
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: Generate Summary Report
        run: |
          echo "# Distributed System Test Report" > test-report.md
          echo "" >> test-report.md
          echo "## Load Test Results" >> test-report.md
          cat load-test-results/* >> test-report.md || echo "No results" >> test-report.md
          echo "" >> test-report.md
          echo "## Failover Test Results" >> test-report.md
          cat failover-test-results/* >> test-report.md || echo "No results" >> test-report.md
          echo "" >> test-report.md
          echo "## E2E Test Results" >> test-report.md
          cat e2e-test-results/* >> test-report.md || echo "No results" >> test-report.md
      
      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: test-report.md
